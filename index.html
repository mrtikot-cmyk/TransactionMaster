<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NBA Trade Calculator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0b;
      --surface: #141416;
      --surface-hover: #1a1a1d;
      --border: #2a2a2e;
      --text: #f5f5f7;
      --text-secondary: #8e8e93;
      --accent: #3b82f6;
      --accent-dim: rgba(59, 130, 246, 0.15);
      --green: #34c759;
      --green-dim: rgba(52, 199, 89, 0.15);
      --orange: #ff9f0a;
      --orange-dim: rgba(255, 159, 10, 0.15);
      --red: #ff453a;
      --red-dim: rgba(255, 69, 58, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    header {
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.03em;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn {
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-family: inherit;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--surface-hover);
    }

    .btn-danger {
      background: var(--red-dim);
      color: var(--red);
      border: 1px solid transparent;
    }

    .btn-danger:hover {
      background: var(--red);
      color: white;
    }

    .trade-container {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding-bottom: 1rem;
    }

    .team-card {
      flex: 1;
      min-width: 280px;
      max-width: 320px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
    }

    .team-card.valid {
      border-color: var(--green);
    }

    .team-card.invalid {
      border-color: var(--red);
    }

    .team-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .team-select {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.9375rem;
      font-family: inherit;
      font-weight: 600;
      background: transparent;
      border: none;
      color: var(--text);
      cursor: pointer;
      outline: none;
    }

    .team-select option {
      background: var(--surface);
      color: var(--text);
    }

    .remove-team-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1.25rem;
      line-height: 1;
      transition: color 0.15s;
    }

    .remove-team-btn:hover {
      color: var(--red);
    }

    .team-status {
      padding: 0.5rem 1rem;
      background: var(--surface-hover);
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .team-status-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .team-body {
      padding: 1rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 200px;
    }

    .section-label {
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .players-out, .players-in {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .player-chip {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background: var(--surface-hover);
      border-radius: 6px;
      font-size: 0.8125rem;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .player-chip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .player-chip-info {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .player-chip-name {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .player-chip-salary {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .player-chip-remove {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      padding: 0.25rem;
      line-height: 1;
    }

    .player-chip-remove:hover {
      color: var(--red);
    }

    .player-destination {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.6875rem;
      color: var(--text-secondary);
    }

    .player-destination-label {
      white-space: nowrap;
    }

    .player-destination-select {
      flex: 1;
      padding: 0.25rem 0.375rem;
      font-size: 0.6875rem;
      font-family: inherit;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
    }

    .player-destination-select option {
      background: var(--surface);
    }

    .player-chip.incoming {
      background: var(--accent-dim);
      border: 1px solid var(--accent);
    }

    .player-chip.incoming .player-chip-remove {
      display: none;
    }

    .add-player-container {
      position: relative;
      margin-top: auto;
    }

    .add-player-input {
      width: 100%;
      padding: 0.625rem 0.75rem;
      font-size: 0.8125rem;
      font-family: inherit;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
    }

    .add-player-input:focus {
      border-color: var(--accent);
    }

    .add-player-input::placeholder {
      color: var(--text-secondary);
    }

    .player-dropdown {
      position: absolute;
      bottom: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 240px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .player-dropdown.active {
      display: block;
    }

    .player-dropdown-item {
      padding: 0.625rem 0.75rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      font-size: 0.8125rem;
    }

    .player-dropdown-item:last-child {
      border-bottom: none;
    }

    .player-dropdown-item:hover {
      background: var(--surface-hover);
    }

    .player-dropdown-item-salary {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .team-footer {
      padding: 1rem;
      border-top: 1px solid var(--border);
      background: var(--surface-hover);
      border-radius: 0 0 12px 12px;
    }

    .salary-summary {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      font-size: 0.8125rem;
    }

    .salary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .salary-label {
      color: var(--text-secondary);
    }

    .salary-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    .salary-value.negative {
      color: var(--red);
    }

    .salary-value.positive {
      color: var(--green);
    }

    .salary-row.total {
      padding-top: 0.375rem;
      margin-top: 0.375rem;
      border-top: 1px solid var(--border);
      font-weight: 600;
    }

    .trade-status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .trade-status.valid {
      background: var(--green-dim);
      border: 1px solid var(--green);
    }

    .trade-status.invalid {
      background: var(--red-dim);
      border: 1px solid var(--red);
    }

    .trade-status.warning {
      background: var(--orange-dim);
      border: 1px solid var(--orange);
    }

    .trade-status-icon {
      font-size: 1.5rem;
    }

    .trade-status-text {
      flex: 1;
    }

    .trade-status-title {
      font-weight: 600;
      font-size: 0.9375rem;
    }

    .trade-status-message {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-top: 0.125rem;
    }

    .add-team-card {
      min-width: 200px;
      max-width: 200px;
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      min-height: 400px;
    }

    .add-team-card:hover {
      border-color: var(--accent);
      background: var(--surface-hover);
    }

    .add-team-content {
      text-align: center;
      color: var(--text-secondary);
    }

    .add-team-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .add-team-text {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .ntc-badge, .restriction-badge {
      font-size: 0.5625rem;
      padding: 0.125rem 0.3rem;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .ntc-badge {
      background: var(--orange-dim);
      color: var(--orange);
    }

    .restriction-badge {
      background: var(--red-dim);
      color: var(--red);
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .divider-line {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .divider-text {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .trade-container {
        flex-direction: column;
      }

      .team-card, .add-team-card {
        max-width: none;
        min-width: auto;
      }

      .add-team-card {
        min-height: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèÄ NBA Trade Calculator</h1>
      <div class="header-actions">
        <button class="btn btn-danger" id="resetBtn">Reset Trade</button>
      </div>
    </header>

    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <p>Loading player data...</p>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="trade-container" id="tradeContainer">
        <!-- Team cards will be added here -->
      </div>

      <div class="trade-status" id="tradeStatus" style="display: none;">
        <div class="trade-status-icon" id="tradeStatusIcon">‚úì</div>
        <div class="trade-status-text">
          <div class="trade-status-title" id="tradeStatusTitle">Trade is valid</div>
          <div class="trade-status-message" id="tradeStatusMessage"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBCO0wPF_TMch0YgAbtFqYkwDWrsxRe7/pub?output=csv';
    const MAX_TEAMS = 5;

    let players = [];
    let teams = [];
    let tradeTeams = []; // Array of { teamName, playersOut: [], playersIn: [] }

    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const mainContent = document.getElementById('mainContent');
    const tradeContainer = document.getElementById('tradeContainer');
    const tradeStatus = document.getElementById('tradeStatus');
    const resetBtn = document.getElementById('resetBtn');

    // Parse salary string to number
    function parseSalary(salaryStr) {
      if (!salaryStr || salaryStr === '') return 0;
      return parseFloat(salaryStr.toString().replace(/[$,]/g, '')) || 0;
    }

    // Format number as currency
    function formatSalary(num) {
      if (num === 0) return '$0';
      const absNum = Math.abs(num);
      const formatted = '$' + absNum.toLocaleString('en-US', { maximumFractionDigits: 0 });
      return num < 0 ? '-' + formatted : formatted;
    }

    // Get unique teams from players
    function getUniqueTeams() {
      const teamSet = new Set(players.map(p => p.team));
      return Array.from(teamSet).sort();
    }

    // Get team info (status, cap space, hardcap) from first player of that team
    function getTeamInfo(teamName) {
      const teamPlayer = players.find(p => p.team === teamName);
      if (!teamPlayer) return null;
      return {
        name: teamName,
        status: teamPlayer.teamStatus,
        capSpace: teamPlayer.capSpace,
        apronRoom1st: teamPlayer.apronRoom1st,
        apronRoom2nd: teamPlayer.apronRoom2nd,
        isHardcap1st: teamPlayer.isHardcap1st,
        isHardcap2nd: teamPlayer.isHardcap2nd
      };
    }

    // Get players for a specific team
    function getTeamPlayers(teamName) {
      return players.filter(p => p.team === teamName);
    }

    // Calculate max incoming salary based on team status and outgoing salary
    function getMaxIncoming(status, outgoingSalary, capSpace = 0) {
      if (status === 'Cap Space') {
        return capSpace + outgoingSalary;
      } else if (status === '2nd Apron') {
        return outgoingSalary + 250000;
      } else if (status === '1st Apron') {
        return outgoingSalary * 1.1 + 250000;
      } else {
        // Below Tax or Tax Team
        return outgoingSalary * 1.75 + 250000;
      }
    }

    // Validate a team's side of the trade
    function validateTeamTrade(tradeTeam) {
      const teamInfo = getTeamInfo(tradeTeam.teamName);
      if (!teamInfo) return { valid: false, message: 'Team not found' };

      const outgoingSalary = tradeTeam.playersOut.reduce((sum, p) => sum + p.salary, 0);
      const incomingSalary = tradeTeam.playersIn.reduce((sum, p) => sum + p.salary, 0);
      const netIncoming = incomingSalary - outgoingSalary;

      // Check hardcap
      if (teamInfo.isHardcap1st && netIncoming > teamInfo.apronRoom1st) {
        return { 
          valid: false, 
          message: `Exceeds 1st apron hardcap by ${formatSalary(netIncoming - teamInfo.apronRoom1st)}` 
        };
      }
      if (teamInfo.isHardcap2nd && netIncoming > teamInfo.apronRoom2nd) {
        return { 
          valid: false, 
          message: `Exceeds 2nd apron hardcap by ${formatSalary(netIncoming - teamInfo.apronRoom2nd)}` 
        };
      }

      // Check salary matching
      let maxIncoming;
      if (teamInfo.status === 'Cap Space') {
        // Cap Space teams can absorb up to their cap space + any outgoing salary
        maxIncoming = teamInfo.capSpace + outgoingSalary;
      } else if (teamInfo.status === '2nd Apron') {
        maxIncoming = outgoingSalary + 250000;
      } else if (teamInfo.status === '1st Apron') {
        maxIncoming = outgoingSalary * 1.1 + 250000;
      } else {
        // Below Tax or Tax Team
        maxIncoming = outgoingSalary * 1.75 + 250000;
      }

      if (incomingSalary > maxIncoming) {
        const deficit = incomingSalary - maxIncoming;
        return { 
          valid: false, 
          message: `Need to send out ${formatSalary(deficit)} more in salary` 
        };
      }

      // Check for trade restrictions
      const restrictions = [];
      tradeTeam.playersOut.forEach(p => {
        if (p.tradeAvailable && p.tradeAvailable.toLowerCase() === 'not available') {
          restrictions.push(`${p.player} cannot be traded before deadline`);
        } else if (p.tradeAvailable) {
          restrictions.push(`${p.player} available ${p.tradeAvailable}`);
        }
        if (p.noTradeClause) {
          restrictions.push(`${p.player} has a no-trade clause`);
        }
      });

      return { 
        valid: true, 
        message: restrictions.length > 0 ? restrictions.join('; ') : 'Trade works',
        warnings: restrictions
      };
    }

    // Validate entire trade
    function validateTrade() {
      // Need at least 2 teams with players
      const activeTeams = tradeTeams.filter(t => t.teamName && t.playersOut.length > 0);
      if (activeTeams.length < 2) {
        return { valid: false, message: 'Add players from at least 2 teams', type: 'warning' };
      }

      // Check that all players have destinations assigned
      let missingDestinations = false;
      activeTeams.forEach(t => {
        t.playersOut.forEach(p => {
          if (p.destination === undefined) {
            missingDestinations = true;
          }
        });
      });

      if (missingDestinations) {
        return { valid: false, message: 'Select destination team for all players', type: 'warning' };
      }

      // Validate each team's side
      let allValid = true;
      let allWarnings = [];
      let invalidMessages = [];
      
      activeTeams.forEach(t => {
        const result = validateTeamTrade(t);
        if (!result.valid) {
          allValid = false;
          invalidMessages.push(`${t.teamName}: ${result.message}`);
        }
        if (result.warnings) {
          allWarnings = allWarnings.concat(result.warnings);
        }
      });

      // Also validate teams that are only receiving (not sending)
      tradeTeams.forEach(t => {
        if (t.teamName && t.playersIn.length > 0 && t.playersOut.length === 0) {
          const result = validateTeamTrade(t);
          if (!result.valid) {
            allValid = false;
            invalidMessages.push(`${t.teamName}: ${result.message}`);
          }
        }
      });

      if (!allValid) {
        return { valid: false, message: invalidMessages.join(' | '), type: 'invalid' };
      }

      if (allWarnings.length > 0) {
        return { valid: true, message: allWarnings.join('; '), type: 'warning' };
      }

      return { valid: true, message: 'All teams can complete this trade', type: 'valid' };
    }

    // Distribute players based on their assigned destinations
    function redistributePlayers() {
      // Clear all incoming players
      tradeTeams.forEach(t => t.playersIn = []);

      // For each player being sent out, add them to their destination team's incoming
      tradeTeams.forEach((team, teamIndex) => {
        team.playersOut.forEach(player => {
          if (player.destination !== undefined && player.destination !== teamIndex) {
            const destTeam = tradeTeams[player.destination];
            if (destTeam) {
              destTeam.playersIn.push(player);
            }
          }
        });
      });
    }

    // Get other active teams (for destination dropdown)
    function getOtherActiveTeams(currentTeamIndex) {
      return tradeTeams
        .map((t, i) => ({ index: i, name: t.teamName }))
        .filter(t => t.name && t.index !== currentTeamIndex);
    }

    // Render a single team card
    function renderTeamCard(tradeTeam, index) {
      const teamInfo = tradeTeam.teamName ? getTeamInfo(tradeTeam.teamName) : null;
      const validation = tradeTeam.teamName && (tradeTeam.playersOut.length > 0 || tradeTeam.playersIn.length > 0) 
        ? validateTeamTrade(tradeTeam) 
        : null;

      const outgoingSalary = tradeTeam.playersOut.reduce((sum, p) => sum + p.salary, 0);
      const incomingSalary = tradeTeam.playersIn.reduce((sum, p) => sum + p.salary, 0);
      const netSalary = incomingSalary - outgoingSalary;

      const cardClass = validation ? (validation.valid ? 'valid' : 'invalid') : '';

      const availableTeams = getUniqueTeams().filter(t => 
        t === tradeTeam.teamName || !tradeTeams.some(tt => tt.teamName === t)
      );

      const otherTeams = getOtherActiveTeams(index);

      return `
        <div class="team-card ${cardClass}" data-index="${index}">
          <div class="team-header">
            <select class="team-select" data-index="${index}">
              <option value="">Select Team...</option>
              ${availableTeams.map(t => `
                <option value="${t}" ${t === tradeTeam.teamName ? 'selected' : ''}>${t}</option>
              `).join('')}
            </select>
            ${tradeTeams.length > 2 ? `
              <button class="remove-team-btn" data-index="${index}">√ó</button>
            ` : ''}
          </div>
          
          ${teamInfo ? `
            <div class="team-status">
              <span class="team-status-item">
                <strong>${teamInfo.status}</strong>
              </span>
              ${teamInfo.isHardcap1st ? `<span class="team-status-item" style="color: var(--orange);">HC 1st</span>` : ''}
              ${teamInfo.isHardcap2nd ? `<span class="team-status-item" style="color: var(--orange);">HC 2nd</span>` : ''}
            </div>
          ` : ''}
          
          <div class="team-body">
            <div class="players-out">
              <div class="section-label">Sends Out</div>
              ${tradeTeam.playersOut.map((p, pIndex) => `
                <div class="player-chip">
                  <div class="player-chip-row">
                    <div class="player-chip-info">
                      <div class="player-chip-name">
                        ${p.player}
                        ${p.noTradeClause ? '<span class="ntc-badge">NTC</span>' : ''}
                        ${p.tradeAvailable ? '<span class="restriction-badge">!</span>' : ''}
                      </div>
                      <div class="player-chip-salary">${formatSalary(p.salary)}</div>
                    </div>
                    <button class="player-chip-remove" data-team="${index}" data-player="${pIndex}">√ó</button>
                  </div>
                  ${otherTeams.length > 0 ? `
                    <div class="player-destination">
                      <span class="player-destination-label">‚Üí To:</span>
                      <select class="player-destination-select" data-team="${index}" data-player="${pIndex}">
                        <option value="">Select team...</option>
                        ${otherTeams.map(t => `
                          <option value="${t.index}" ${p.destination === t.index ? 'selected' : ''}>${t.name}</option>
                        `).join('')}
                      </select>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
              
              ${tradeTeam.teamName ? `
                <div class="add-player-container">
                  <input 
                    type="text" 
                    class="add-player-input" 
                    placeholder="Add player..."
                    data-team="${index}"
                  >
                  <div class="player-dropdown" data-team="${index}"></div>
                </div>
              ` : ''}
            </div>
            
            ${tradeTeam.playersIn.length > 0 ? `
              <div class="divider">
                <div class="divider-line"></div>
                <div class="divider-text">Receives</div>
                <div class="divider-line"></div>
              </div>
              
              <div class="players-in">
                ${tradeTeam.playersIn.map(p => `
                  <div class="player-chip incoming">
                    <div class="player-chip-info">
                      <div class="player-chip-name">${p.player}</div>
                      <div class="player-chip-salary">${formatSalary(p.salary)}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          
          ${tradeTeam.teamName && (tradeTeam.playersOut.length > 0 || tradeTeam.playersIn.length > 0) ? `
            <div class="team-footer">
              <div class="salary-summary">
                <div class="salary-row">
                  <span class="salary-label">Outgoing</span>
                  <span class="salary-value">${formatSalary(outgoingSalary)}</span>
                </div>
                <div class="salary-row">
                  <span class="salary-label">Incoming</span>
                  <span class="salary-value">${formatSalary(incomingSalary)}</span>
                </div>
                <div class="salary-row total">
                  <span class="salary-label">Net</span>
                  <span class="salary-value ${netSalary > 0 ? 'negative' : netSalary < 0 ? 'positive' : ''}">${netSalary > 0 ? '+' : ''}${formatSalary(netSalary)}</span>
                </div>
              </div>
              ${validation && !validation.valid ? `
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--red);">
                  ‚ö†Ô∏è ${validation.message}
                </div>
              ` : ''}
              ${validation && validation.warnings && validation.warnings.length > 0 ? `
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--orange);">
                  ‚ö†Ô∏è ${validation.warnings.join('; ')}
                </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;
    }

    // Render add team card
    function renderAddTeamCard() {
      if (tradeTeams.length >= MAX_TEAMS) return '';
      return `
        <div class="add-team-card" id="addTeamCard">
          <div class="add-team-content">
            <div class="add-team-icon">+</div>
            <div class="add-team-text">Add Team</div>
          </div>
        </div>
      `;
    }

    // Render trade status
    function renderTradeStatus() {
      const validation = validateTrade();
      
      if (!tradeTeams.some(t => t.playersOut.length > 0)) {
        tradeStatus.style.display = 'none';
        return;
      }

      tradeStatus.style.display = 'flex';
      tradeStatus.className = 'trade-status ' + validation.type;
      
      document.getElementById('tradeStatusIcon').textContent = 
        validation.type === 'valid' ? '‚úì' : 
        validation.type === 'warning' ? '‚ö†Ô∏è' : '‚úó';
      
      document.getElementById('tradeStatusTitle').textContent = 
        validation.type === 'valid' ? 'Trade is valid' :
        validation.type === 'warning' ? 'Trade has warnings' : 'Trade is invalid';
      
      document.getElementById('tradeStatusMessage').textContent = validation.message;
    }

    // Main render function
    function render() {
      tradeContainer.innerHTML = tradeTeams.map((t, i) => renderTeamCard(t, i)).join('') + renderAddTeamCard();
      renderTradeStatus();
      attachEventListeners();
    }

    // Attach event listeners
    function attachEventListeners() {
      // Team select change
      document.querySelectorAll('.team-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.index);
          tradeTeams[index].teamName = e.target.value;
          tradeTeams[index].playersOut = [];
          tradeTeams[index].playersIn = [];
          redistributePlayers();
          render();
        });
      });

      // Remove team
      document.querySelectorAll('.remove-team-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          tradeTeams.splice(index, 1);
          redistributePlayers();
          render();
        });
      });

      // Remove player
      document.querySelectorAll('.player-chip-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const teamIndex = parseInt(e.target.dataset.team);
          const playerIndex = parseInt(e.target.dataset.player);
          tradeTeams[teamIndex].playersOut.splice(playerIndex, 1);
          redistributePlayers();
          render();
        });
      });

      // Player destination change
      document.querySelectorAll('.player-destination-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const teamIndex = parseInt(e.target.dataset.team);
          const playerIndex = parseInt(e.target.dataset.player);
          const destinationIndex = e.target.value ? parseInt(e.target.value) : undefined;
          tradeTeams[teamIndex].playersOut[playerIndex].destination = destinationIndex;
          redistributePlayers();
          render();
        });
      });

      // Add team
      const addTeamCard = document.getElementById('addTeamCard');
      if (addTeamCard) {
        addTeamCard.addEventListener('click', () => {
          tradeTeams.push({ teamName: '', playersOut: [], playersIn: [] });
          render();
        });
      }

      // Player search inputs
      document.querySelectorAll('.add-player-input').forEach(input => {
        const teamIndex = parseInt(input.dataset.team);
        const dropdown = document.querySelector(`.player-dropdown[data-team="${teamIndex}"]`);
        
        input.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          if (query.length < 2) {
            dropdown.classList.remove('active');
            return;
          }

          const teamName = tradeTeams[teamIndex].teamName;
          const teamPlayers = getTeamPlayers(teamName);
          const alreadyAdded = tradeTeams[teamIndex].playersOut.map(p => p.player);
          
          const matches = teamPlayers
            .filter(p => p.player.toLowerCase().includes(query))
            .filter(p => !alreadyAdded.includes(p.player))
            .slice(0, 8);

          if (matches.length === 0) {
            dropdown.classList.remove('active');
            return;
          }

          dropdown.innerHTML = matches.map(p => `
            <div class="player-dropdown-item" data-player="${p.player}">
              <span>${p.player}</span>
              <span class="player-dropdown-item-salary">${formatSalary(p.salary)}</span>
            </div>
          `).join('');

          dropdown.classList.add('active');

          // Attach click listeners to dropdown items
          dropdown.querySelectorAll('.player-dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
              const playerName = item.dataset.player;
              const player = teamPlayers.find(p => p.player === playerName);
              if (player) {
                // Create a copy of the player with destination property
                const playerWithDest = { ...player };
                
                // Auto-assign destination for 2-team trades
                const otherTeams = getOtherActiveTeams(teamIndex);
                if (otherTeams.length === 1) {
                  playerWithDest.destination = otherTeams[0].index;
                }
                
                tradeTeams[teamIndex].playersOut.push(playerWithDest);
                redistributePlayers();
                render();
              }
            });
          });
        });

        input.addEventListener('blur', () => {
          setTimeout(() => dropdown.classList.remove('active'), 200);
        });
      });
    }

    // Reset trade
    resetBtn.addEventListener('click', () => {
      tradeTeams = [
        { teamName: '', playersOut: [], playersIn: [] },
        { teamName: '', playersOut: [], playersIn: [] }
      ];
      render();
    });

    // Load data
    async function loadData() {
      try {
        const response = await fetch(CSV_URL);
        const csvText = await response.text();
        
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            players = results.data
              .filter(row => row.PLAYER && row.PLAYER.trim())
              .filter(row => row.TEAM && row.TEAM.trim())
              .filter(row => {
                const contractStatus = row['ST 25-26']?.trim() || '';
                return !contractStatus.toLowerCase().includes('10-day');
              })
              .map(row => ({
                player: row.PLAYER?.trim() || '',
                team: row.TEAM?.trim() || '',
                salary: parseSalary(row['2026']),
                contractStatus: row['ST 25-26']?.trim() || '',
                teamStatus: row['TEAM STATUS']?.trim() || '',
                capSpace: parseSalary(row['Cap Space'] || row['H'] || 0),
                globalRating: parseFloat(row['RAT 365'] || 0) || 0,
                noTradeClause: (row['NO TRADE'] || '').toString().trim().toUpperCase() === 'YES',
                apronRoom1st: parseSalary(row['1st APRON'] || 0),
                apronRoom2nd: parseSalary(row['2nd APRON'] || 0),
                isHardcap1st: (row['HARD CAP 1st?'] || '').toString().trim().toLowerCase().includes('hc'),
                isHardcap2nd: (row['HARD CAP 2nd?'] || '').toString().trim().toLowerCase().includes('hc'),
                tradeAvailable: row['RESTRICTIONS']?.trim() || ''
              }));

            teams = getUniqueTeams();
            
            // Initialize with 2 empty team slots
            tradeTeams = [
              { teamName: '', playersOut: [], playersIn: [] },
              { teamName: '', playersOut: [], playersIn: [] }
            ];

            loadingState.style.display = 'none';
            mainContent.style.display = 'block';
            render();
          },
          error: function(error) {
            console.error('Parse error:', error);
            loadingState.innerHTML = '<p>Error loading data. Please refresh the page.</p>';
          }
        });
      } catch (error) {
        console.error('Fetch error:', error);
        loadingState.innerHTML = '<p>Error loading data. Please refresh the page.</p>';
      }
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
